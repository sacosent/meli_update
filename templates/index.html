<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utilização Fleet Status Updater</title>
  <style>
    :root {
      --green: #00ff7f;
      --black: #111;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--black);
      color: white;
      max-width: 700px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0, 255, 127, 0.3);
      background: linear-gradient(160deg, #111, #1a1a1a);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--green);
    }
    .logo {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .logo img {
      width: 200px;
      max-width: 100%;
      margin-bottom: 8px;
    }
    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: var(--green);
      letter-spacing: 2px;
    }
    label, input, button {
      display: block;
      width: 100%;
      margin-top: 15px;
    }
    input[type="file"] {
      padding: 8px;
      border-radius: 6px;
      background-color: #1f1f1f;
      border: 1px solid #333;
      color: white;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      background: var(--green);
      color: #111;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #progress-container {
      width: 100%;
      background-color: #333;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 20px;
    }
    #progress-bar {
      height: 8px;
      width: 0%;
      background: var(--green);
      transition: width 0.3s ease-in-out;
    }
    #results {
      margin-top: 30px;
    }
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background-color: #222;
    }
    th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: var(--green);
      color: #111;
    }
    #download-link {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    #download-link a {
      color: var(--green);
      font-weight: bold;
    }
    .download-btn {
    background: #007f4f;
    color: white;
  }
</style>
</head>
<body>
  <div class="logo">
    <img src="/static/logo.png" alt="ZuCo Logo">
  </div>

  <h2>Fleet Status Updater</h2>

  <label>Fleet File (fleet-moviles.xls):</label>
  <input type="file" id="fleet-file">

  <label>Idle File (disponibilidad.xls):</label>
  <input type="file" id="disp-file">

  <button onclick="enviarArchivos()">Process Files</button>

  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="status"></div>
  <div id="download-link"></div>
  <div id="results"></div>
  

  <script>
    async function enviarArchivos() {
      const fleetFile = document.getElementById('fleet-file').files[0];
      const dispFile = document.getElementById('disp-file').files[0];
      const status = document.getElementById('status');
      const results = document.getElementById('results');
      const download = document.getElementById('download-link');
      const progressBar = document.getElementById('progress-bar');

      if (!fleetFile || !dispFile) {
        status.innerText = '⚠️ Both files are required';
        return;
      }

      const formData = new FormData();
      formData.append("fleet_file", fleetFile);
      formData.append("disponibilidad_file", dispFile);

      status.innerText = 'Processing...';
      progressBar.style.width = '10%';
      
      let progress = 0;
      progressBar.style.width = '10%';
      const interval = setInterval(() => {
        if (progress < 85) {
          progress += 1;
          progressBar.style.width = progress + '%';
        }
      }, 50);

      status.innerText = 'Creating Excel and Statistics...';

      results.innerHTML = '';
      download.innerHTML = '';

      const res = await fetch("/process", {
        method: "POST",
        body: formData
      });

      let data;
      try {
        data = await res.json();
        progressBar.style.width = '80%';
      } catch (e) {
        status.innerText = '❌ Error: Invalid server response';
        return;
      }

      if (!res.ok) {
        status.innerText = '❌ Error: ' + (data.error || 'Unknown');
        return;
      }

      status.innerText = '✅ Process completed';
      progressBar.style.width = '100%';

      // Table
      if (data.table_data && data.table_data.length > 0) {
        const table = document.createElement("table");
        const headers = Object.keys(data.table_data[0]);
        const thead = document.createElement("thead");
        const tr = document.createElement("tr");
        headers.forEach(h => {
          const th = document.createElement("th");
          th.innerText = h;
          tr.appendChild(th);
        });
        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        data.table_data.forEach(row => {
          const tr = document.createElement("tr");
          headers.forEach(h => {
            const td = document.createElement("td");
            td.innerText = row[h];
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        results.appendChild(table);
      }

      // Download link
      const downloadBtn = document.createElement("button");
      downloadBtn.textContent = "⬇️ Download Excel ⬇️";
      downloadBtn.className = "download-btn";
      downloadBtn.onclick = async () => {
        const res = await fetch("/download");
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = data.filename || "vehicle_fleet_update.xlsx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      };
      download.innerHTML = '';
      download.appendChild(downloadBtn);
      download.style.display = 'block';
      }
    
  </script>
</body>
</html>
