<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atualizador de Status da Frota</title>
  <style>
    :root{
      --ml-yellow:#FFE600;
      --ml-blue:#2D3277;
      --ml-blue-dark:#1e235c;
      --ml-text:#333;
      --ml-white:#ffffff;
      --ml-border:#e6e6e6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:var(--ml-yellow);
      color:var(--ml-text);
    }
    .wrap{
      max-width:820px;
      margin:48px auto;
      padding:0 16px;
    }
    .brand {
     display: flex;
      flex-direction: column; /* apila verticalmente */
      align-items: center;    /* centra horizontalmente */
      gap: 16px;               /* espacio entre logo y t√≠tulo */
    }
    .brand img{height:144px;width:auto}
    .vecfleet-logo {
      position: fixed;
      bottom: 2%;
      right: 2%;
      width: clamp(80px, 12vw, 150px); /* m√≠nimo 80px, m√°ximo 150px, escalando con la pantalla */
      height: auto;
      opacity: 0.9;
      z-index: 9999;
    }
    .vecfleet-logo:hover {
      opacity: 1;
    }


    .brand h1{
      font-size:20px;
      margin:0;
      color:var(--ml-blue);
      font-weight:700;
      letter-spacing:.2px;
    }
    .card{
      background:var(--ml-white);
      border:1px solid var(--ml-border);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    h2{
      color:var(--ml-blue);
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:700;
    }
    label{display:block;margin-top:14px;font-weight:600;color:#444}
    input[type="file"]{
      width:100%;
      margin-top:6px;
      padding:10px;
      background:#fafafa;
      border:1px solid var(--ml-border);
      border-radius:8px;
    }
    button{
      margin-top:18px;
      padding:12px 14px;
      background:var(--ml-blue);
      color:#fff;
      font-weight:700;
      border:none;border-radius:10px;
      cursor:pointer;
    }
    button:hover{background:var(--ml-blue-dark)}
    .progress{
      width:100%;
      background:#f1f1f1;
      border-radius:8px;
      overflow:hidden;
      margin-top:18px;
      border:1px solid var(--ml-border);
    }
    .bar{
      height:10px;width:0%;
      background:var(--ml-blue);
      transition:width .25s ease;
    }
    #status{margin-top:10px;font-size:14px;color:#555}
    #download{
      display:none;margin-top:16px;
    }
    .download-btn{
      background:var(--ml-blue);
      color:#fff;border:none;border-radius:10px;
      padding:10px 12px;font-weight:700;cursor:pointer;
    }
    .download-btn:hover{background:var(--ml-blue-dark)}
    table{
      width:100%;margin-top:16px;border-collapse:collapse;border:1px solid var(--ml-border);
      background:#fff;border-radius:10px;overflow:hidden
    }
    thead th{
      background:var(--ml-blue);color:#fff;text-align:left;padding:10px;font-weight:700
    }
    tbody td{padding:10px;border-top:1px solid var(--ml-border)}
    .muted{color:#777}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <!-- Troque o src pela sua imagem/rota em produ√ß√£o -->
      <img src="/static/logo_ml.png" alt="Mercado Livre">
      <h1>Ferramenta interna</h1>
    </div>

    <div class="card">
      <h2>Atualizador de Status da Frota</h2>
      <p class="muted">Carregue os arquivos, processe e baixe a planilha de atualiza√ß√£o.</p>

      <label>Arquivo da Frota (fleet-moviles.xls):</label>
      <input type="file" id="fleet-file" />

      <label>Arquivo de Disponibilidade (disponibilidad.xls):</label>
      <input type="file" id="disp-file" />

      <button id="process-btn" onclick="processar()">Processar Arquivos</button>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status"></div>

      <div id="download"></div>

      <div id="results"></div>
    </div>
  </div>
  <img src="/static/vecfleet.png" alt="VecFleet Logo" class="vecfleet-logo">


  <script>
    async function processar(){
      const fleet = document.getElementById('fleet-file').files[0];
      const disp  = document.getElementById('disp-file').files[0];
      const status = document.getElementById('status');
      const bar = document.getElementById('bar');
      const results = document.getElementById('results');
      const download = document.getElementById('download');

      if(!fleet || !disp){
        status.textContent = '‚ö†Ô∏è Ambos os arquivos s√£o obrigat√≥rios.';
        return;
      }

      // Reset UI
      results.innerHTML = '';
      download.innerHTML = '';
      download.style.display = 'none';
      status.textContent = 'Iniciando processamento...';
      bar.style.width = '10%';

      // Fake progress up to 85% enquanto o backend processa
      let p = 10;
      const anim = setInterval(() => {
        if(p < 85){ p += 1; bar.style.width = p + '%'; }
      }, 50);

      const form = new FormData();
      form.append('fleet_file', fleet);
      form.append('disponibilidad_file', disp);

      const res = await fetch('/process', { method:'POST', body:form });

      let data;
      try{
        data = await res.json();
      }catch(e){
        clearInterval(anim);
        status.textContent = '‚ùå Erro: resposta inv√°lida do servidor.';
        return;
      }

      if(!res.ok){
        clearInterval(anim);
        status.textContent = '‚ùå Erro: ' + (data.error || 'Desconhecido');
        return;
      }

      // Completa a barra
      clearInterval(anim);
      bar.style.width = '100%';
      status.textContent = '‚úÖ Processamento conclu√≠do.';

      // Tabela (converte as chaves para PT-BR visualmente)
      if (data.table_data && data.table_data.length > 0){
        const headersMap = { "Estado":"Estado", "Cantidad":"Quantidade", "Porcentaje":"Porcentagem (%)" };

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');

        const headerKeys = Object.keys(data.table_data[0]);
        headerKeys.forEach(key=>{
          const th = document.createElement('th');
          th.textContent = headersMap[key] || key;
          trh.appendChild(th);
        });
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.table_data.forEach(row=>{
          const tr = document.createElement('tr');
          headerKeys.forEach(k=>{
            const td = document.createElement('td');
            td.textContent = row[k];
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        results.appendChild(table);
      }

      // Bot√£o de download (chama /download para arquivo bin√°rio correto) 
      const btn = document.createElement('button');
      btn.className = 'download-btn';
      btn.textContent = 'üìó Baixar Excel üìó';
      btn.onclick = async () => {
        const r = await fetch('/download');
        if(!r.ok){ status.textContent = '‚ùå Erro ao preparar o download.'; return; }
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (data.filename || 'vehicle_fleet_update.xlsx');
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };
      download.appendChild(btn);
      download.style.display = 'block';
    }
  </script>
</body>
</html>
