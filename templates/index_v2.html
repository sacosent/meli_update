<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atualizador de Status da Frota</title>
  <style>
    :root{
      --ml-yellow:#FFE600;
      --ml-blue:#2D3277;
      --ml-blue-dark:#1e235c;
      --ml-text:#333;
      --ml-white:#ffffff;
      --ml-border:#e6e6e6;
      --ml-muted:#777;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:var(--ml-yellow);
      color:var(--ml-text);
    }
    .wrap{max-width:980px;margin:48px auto;padding:0 16px}
    .brand{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px}
    .brand img{height:144px;width:auto}
    .brand h1{font-size:20px;margin:0;color:var(--ml-blue);font-weight:800;letter-spacing:.2px}
    .card{
      background:var(--ml-white);
      border:1px solid var(--ml-border);
      border-radius:12px;
      padding:20px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      margin-bottom:18px;
    }
    h2{color:var(--ml-blue);margin:0 0 10px 0;font-size:18px;font-weight:700}
    label{display:block;margin-top:14px;font-weight:600;color:#444}
    input[type="file"]{
      width:100%;margin-top:6px;padding:10px;background:#fafafa;
      border:1px solid var(--ml-border);border-radius:8px;
    }
    .upload-btn,.download-btn,button{
      margin-top:18px;padding:12px 14px;background:var(--ml-blue);color:#fff;font-weight:700;
      border:none;border-radius:10px;cursor:pointer;
    }
    .upload-btn:hover,.download-btn:hover,button:hover{background:var(--ml-blue-dark)}
    .progress{width:100%;background:#f1f1f1;border-radius:8px;overflow:hidden;margin-top:18px;border:1px solid var(--ml-border)}
    .bar{height:10px;width:0%;background:var(--ml-blue);transition:width .25s ease}
    #status{margin-top:10px;font-size:14px;color:#555}
    #download{display:none;margin-top:16px;display:flex;justify-content:center}

    /* Tabela */
    table{
      width:100%;margin-top:16px;border-collapse:collapse;border:1px solid var(--ml-border);
      background:#fff;border-radius:10px;overflow:hidden
    }
    thead th{background:var(--ml-blue);color:#fff;text-align:left;padding:10px;font-weight:700}
    tbody td{padding:10px;border-top:1px solid var(--ml-border)}
    .muted{color:var(--ml-muted)}

    /* KPIs / Estat√≠sticas */
    .kpis{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
    }
    .kpi{
      background:#fafafa;border:1px solid var(--ml-border);border-radius:10px;
      padding:14px;text-align:center;
    }
    .kpi .label{font-size:12px;color:var(--ml-muted);text-transform:uppercase;letter-spacing:.4px}
    .kpi .value{margin-top:6px;font-size:22px;font-weight:800;color:var(--ml-blue)}
    .section-title{margin-top:12px;font-weight:700;color:var(--ml-blue)}

    /* Logo VecFleet */
    .vecfleet-logo{
      position:fixed;bottom:2%;right:2%;
      width:clamp(80px, 12vw, 150px);height:auto;opacity:.9;z-index:9999;
    }
    .vecfleet-logo:hover{opacity:1}
    .error{color:#b00020;font-weight:600;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="/static/logo_ml.png" alt="Mercado Livre">
      <h1>Ferramenta interna ¬∑ Mercado Livre</h1>
    </div>

    <div class="card">
      <h2>Atualizador de Status da Frota</h2>
      <p class="muted">Carregue os arquivos, processe e baixe a planilha de atualiza√ß√£o.</p>

      <label>Arquivo da Frota (fleet-moviles.xlsx):</label>
      <input type="file" id="fleet-file" accept=".xlsx"/>

      <label>Arquivo de Disponibilidade (disponibilidade.xlsx):</label>
      <input type="file" id="disp-file" accept=".xlsx"/>

      <button id="process-btn" class="upload-btn" onclick="processar()">üì§ Enviar</button>

      <div class="progress"><div id="bar" class="bar"></div></div>
      <div id="status"></div>
    </div>

    <!-- Estat√≠sticas -->
    <div id="stats-card" class="card" style="display:none;">
      <h2>Estat√≠sticas</h2>
      <div class="kpis" id="kpi-grid"></div>

      <div class="section-title">Distribui√ß√£o por Estado</div>
      <div id="table-container"></div>

      <div id="download"></div>
    </div>
  </div>

  <img src="/static/vecfleet.png" alt="VecFleet Logo" class="vecfleet-logo">

  <script>
    function okFile(file){
      if(!file) return false;
      const name = (file.name || '').toLowerCase();
      const goodExt = name.endsWith('.xlsx');
      const goodSize = file.size <= 20*1024*1024; // 20MB
      return goodExt && goodSize;
    }

    function kpi(label, value){
      const div = document.createElement('div');
      div.className = 'kpi';
      div.innerHTML = `<div class="label">${label}</div><div class="value">${value}</div>`;
      return div;
    }

    function renderKpis(container, data){
      container.innerHTML = '';

      const totalFleet = Array.isArray(data.table_data)
        ? data.table_data.reduce((acc, r) => acc + (Number(r.Cantidad) || 0), 0)
        : 0;

      const cs = data.changes_summary || {};
      const totalRows = cs.total_rows ?? 0;
      const estadoChanges = cs.estado_changes ?? 0;
      const svcChanges = cs.svc_changes ?? 0;
      const mlpChanges = cs.mlp_changes ?? 0;
      const bothChanges = cs.both_changes ?? 0;

      container.appendChild(kpi('Ve√≠culos analisados', totalFleet));
      container.appendChild(kpi('Linhas de atualiza√ß√£o', totalRows));
      container.appendChild(kpi('Mudan√ßas de Estado', estadoChanges));
      container.appendChild(kpi('Mudan√ßas de SVC (Base)', svcChanges));
      container.appendChild(kpi('Mudan√ßas de MLP (Centro de Custos)', mlpChanges));
      container.appendChild(kpi('Mudan√ßas combinadas (SVC + MLP)', bothChanges));
    }

    function renderEstadoTable(container, tableData){
      if(!Array.isArray(tableData) || tableData.length === 0){
        container.innerHTML = '<p class="muted">Sem dados de distribui√ß√£o por Estado.</p>';
        return;
      }
      let html = '<table><thead><tr><th>Estado</th><th>Quantidade</th><th>Porcentagem (%)</th></tr></thead><tbody>';
      for(const row of tableData){
        html += `<tr><td>${row.Estado}</td><td>${row.Cantidad}</td><td>${row.Porcentaje}</td></tr>`;
      }
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function processar(){
      const fleet = document.getElementById('fleet-file').files[0];
      const disp  = document.getElementById('disp-file').files[0];
      const status = document.getElementById('status');
      const bar = document.getElementById('bar');
      const statsCard = document.getElementById('stats-card');
      const tableContainer = document.getElementById('table-container');
      const kpiGrid = document.getElementById('kpi-grid');
      const download = document.getElementById('download');

      // Reset UI
      statsCard.style.display = 'none';
      tableContainer.innerHTML = '';
      kpiGrid.innerHTML = '';
      download.innerHTML = '';
      download.style.display = 'none';
      status.textContent = '';

      if(!okFile(fleet) || !okFile(disp)){
        status.innerHTML = '<span class="error">‚ö†Ô∏è Envie arquivos .xlsx de at√© 20MB.</span>';
        return;
      }

      status.textContent = 'Iniciando processamento...';
      bar.style.width = '10%';

      // Progress fake at√© 85%
      let p = 10;
      const anim = setInterval(() => {
        if(p < 85){ p += 1; bar.style.width = p + '%'; }
      }, 50);

      const form = new FormData();
      form.append('fleet_file', fleet);
      form.append('disponibilidad_file', disp);

      let res;
      try {
        res = await fetch('/process', { method:'POST', body: form });
      } catch (e) {
        clearInterval(anim);
        status.innerHTML = '<span class="error">‚ùå Erro de rede ao chamar /process.</span>';
        return;
      }

      let data;
      try {
        data = await res.json();
      } catch (e) {
        clearInterval(anim);
        status.innerHTML = '<span class="error">‚ùå Resposta inv√°lida do servidor.</span>';
        return;
      }

      if(!res.ok || data.error){
        clearInterval(anim);
        status.innerHTML = '<span class="error">‚ùå ' + (data.error || 'Erro desconhecido') + '</span>';
        return;
      }

      clearInterval(anim);
      bar.style.width = '100%';
      status.textContent = '‚úÖ Processamento conclu√≠do.';

      // Estat√≠sticas
      renderKpis(kpiGrid, data);
      renderEstadoTable(tableContainer, data.table_data);
      statsCard.style.display = 'block';

      // Bot√£o de download com token (/download/{token})
      if (data.token){
        download.style.display = 'flex';
        download.innerHTML = '';
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.textContent = '‚¨áÔ∏è Baixar Excel';
        btn.onclick = () => { window.location.href = `/download/${encodeURIComponent(data.token)}`; };
        download.appendChild(btn);
      }
    }
  </script>
</body>
</html>
